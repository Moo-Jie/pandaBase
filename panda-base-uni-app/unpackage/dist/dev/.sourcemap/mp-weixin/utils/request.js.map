{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["// API 请求工具\nconst BASE_URL = 'http://localhost:8101/api';\nconst COOKIE_KEY = 'user_cookies';\n\n/**\n * 封装 uni.request\n * @param {Object} options 请求配置\n */\nfunction request(options) {\n\treturn new Promise((resolve, reject) => {\n\t\t// 构建请求头\n\t\tconst headers = {\n\t\t\t'Content-Type': 'application/json',\n\t\t\t...options.header\n\t\t};\n\t\t\n\t\t// 自动携带 Cookie\n\t\tconst cookie = uni.getStorageSync(COOKIE_KEY);\n\t\tif (cookie) {\n\t\t\theaders['Cookie'] = cookie;\n\t\t}\n\t\t\n\t\tuni.request({\n\t\t\turl: BASE_URL + options.url,\n\t\t\tmethod: options.method || 'GET',\n\t\t\tdata: options.data || {},\n\t\t\theader: headers,\n\t\t\t// 让微信小程序自动管理Cookie（携带和保存）\n\t\t\twithCredentials: true,\n\t\t\tsuccess: (res) => {\n\t\t\t\tconsole.log('响应结果:', res);\n\t\t\t\t\n\t\t\t\t// 手动处理 Set-Cookie\n\t\t\t\tlet setCookie = res.header['Set-Cookie'] || res.header['set-cookie'];\n\t\t\t\tif (setCookie) {\n\t\t\t\t\t// 统一转为数组\n\t\t\t\t\tif (!Array.isArray(setCookie)) {\n\t\t\t\t\t\tsetCookie = [setCookie];\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t// 提取新 Cookie\n\t\t\t\t\tconst newCookies = {};\n\t\t\t\t\tsetCookie.forEach(str => {\n\t\t\t\t\t\tconst part = str.split(';')[0].trim();\n\t\t\t\t\t\tif (part) {\n\t\t\t\t\t\t\tconst [key, value] = part.split('=');\n\t\t\t\t\t\t\tif (key) newCookies[key] = value;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\t\n\t\t\t\t\t// 获取旧 Cookie 并合并\n\t\t\t\t\tconst oldCookieStr = uni.getStorageSync(COOKIE_KEY) || '';\n\t\t\t\t\tconst cookieMap = {};\n\t\t\t\t\t\n\t\t\t\t\t// 解析旧 Cookie\n\t\t\t\t\tif (oldCookieStr) {\n\t\t\t\t\t\toldCookieStr.split(';').forEach(item => {\n\t\t\t\t\t\t\tconst part = item.trim();\n\t\t\t\t\t\t\tif (part) {\n\t\t\t\t\t\t\t\tconst [key, value] = part.split('=');\n\t\t\t\t\t\t\t\tif (key) cookieMap[key] = value;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t// 合并（新覆盖旧）\n\t\t\t\t\tObject.assign(cookieMap, newCookies);\n\t\t\t\t\t\n\t\t\t\t\t// 重新生成 Cookie 字符串\n\t\t\t\t\tconst finalCookie = Object.keys(cookieMap)\n\t\t\t\t\t\t.map(key => `${key}=${cookieMap[key] || ''}`)\n\t\t\t\t\t\t.join('; ');\n\t\t\t\t\t\t\n\t\t\t\t\tuni.setStorageSync(COOKIE_KEY, finalCookie);\n\t\t\t\t}\n\n\t\t\t\t// 根据后端返回的数据结构进行处理\n\t\t\t\tif (res.statusCode === 200) {\n\t\t\t\t\tif (res.data.code === 0) {\n\t\t\t\t\t\tresolve(res.data.data);\n\t\t\t\t\t} else if (res.data.code === 40100) {\n\t\t\t\t\t\t// 未登录错误码\n\t\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\t\ttitle: '请先登录',\n\t\t\t\t\t\t\ticon: 'none',\n\t\t\t\t\t\t\tduration: 1500\n\t\t\t\t\t\t});\n\t\t\t\t\t\t// 跳转到登录页\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tuni.navigateTo({\n\t\t\t\t\t\t\t\turl: '/pages/login/login'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}, 1500);\n\t\t\t\t\t\treject(res.data);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// 其他业务错误\n\t\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\t\ttitle: res.data.message || '请求失败',\n\t\t\t\t\t\t\ticon: 'none',\n\t\t\t\t\t\t\tduration: 2000\n\t\t\t\t\t\t});\n\t\t\t\t\t\treject(res.data);\n\t\t\t\t\t}\n\t\t\t\t} else if (res.statusCode === 401) {\n\t\t\t\t\t// HTTP 401 未登录\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '请先登录',\n\t\t\t\t\t\ticon: 'none',\n\t\t\t\t\t\tduration: 1500\n\t\t\t\t\t});\n\t\t\t\t\t// 跳转到登录页\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tuni.navigateTo({\n\t\t\t\t\t\t\turl: '/pages/login/login'\n\t\t\t\t\t\t});\n\t\t\t\t\t}, 1500);\n\t\t\t\t\treject(res.data);\n\t\t\t\t} else {\n\t\t\t\t\t// HTTP 错误\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '网络错误',\n\t\t\t\t\t\ticon: 'none',\n\t\t\t\t\t\tduration: 2000\n\t\t\t\t\t});\n\t\t\t\t\treject(res);\n\t\t\t\t}\n\t\t\t},\n\t\t\tfail: (err) => {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '网络请求失败',\n\t\t\t\t\ticon: 'none',\n\t\t\t\t\tduration: 2000\n\t\t\t\t});\n\t\t\t\treject(err);\n\t\t\t}\n\t\t});\n\t});\n}\n\n// GET 请求\nexport function get(url, data = {}, header = {}) {\n\treturn request({\n\t\turl,\n\t\tmethod: 'GET',\n\t\tdata,\n\t\theader\n\t});\n}\n\n// POST 请求\nexport function post(url, data = {}, header = {}) {\n\treturn request({\n\t\turl,\n\t\tmethod: 'POST',\n\t\tdata,\n\t\theader\n\t});\n}\n\n// PUT 请求\nexport function put(url, data = {}, header = {}) {\n\treturn request({\n\t\turl,\n\t\tmethod: 'PUT',\n\t\tdata,\n\t\theader\n\t});\n}\n\n// DELETE 请求\nexport function del(url, data = {}, header = {}) {\n\treturn request({\n\t\turl,\n\t\tmethod: 'DELETE',\n\t\tdata,\n\t\theader\n\t});\n}\n\n/**\n * 下载文件请求\n * @param {Object} options 请求配置\n */\nexport function download(options) {\n\treturn new Promise((resolve, reject) => {\n\t\t// 构建请求头\n\t\tconst headers = {\n\t\t\t'Content-Type': 'application/json',\n\t\t\t...options.header\n\t\t};\n\t\t\n\t\t// 自动携带 Cookie\n\t\tconst cookie = uni.getStorageSync(COOKIE_KEY);\n\t\tif (cookie) {\n\t\t\theaders['Cookie'] = cookie;\n\t\t}\n\t\t\n\t\tuni.request({\n\t\t\turl: BASE_URL + options.url,\n\t\t\tmethod: options.method || 'POST',\n\t\t\tdata: options.data || {},\n\t\t\theader: headers,\n\t\t\tresponseType: 'arraybuffer',\n\t\t\twithCredentials: true,\n\t\t\tsuccess: (res) => {\n\t\t\t\tif (res.statusCode === 200) {\n\t\t\t\t\tresolve(res);\n\t\t\t\t} else {\n\t\t\t\t\t// 尝试解析错误信息\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// 简单的 ArrayBuffer 转 String\n\t\t\t\t\t\tconst uint8Arr = new Uint8Array(res.data);\n\t\t\t\t\t\tlet jsonStr = '';\n\t\t\t\t\t\tfor (let i = 0; i < uint8Arr.length; i++) {\n\t\t\t\t\t\t\tjsonStr += String.fromCharCode(uint8Arr[i]);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// 处理中文乱码（如果有）- 简单方式可能不行，但错误信息一般是英文或 simple\n\t\t\t\t\t\t// 更好的方式是 decodeURIComponent(escape(jsonStr)) 如果是 UTF-8\n\t\t\t\t\t\t// 这里不做太复杂，直接提示状态码\n\t\t\t\t\t\tconst data = JSON.parse(jsonStr);\n\t\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\t\ttitle: data.message || '下载失败',\n\t\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t\t});\n\t\t\t\t\t\treject(data);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\t\ttitle: '下载失败，状态码：' + res.statusCode,\n\t\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t\t});\n\t\t\t\t\t\treject(res);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\tfail: (err) => {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '网络请求失败',\n\t\t\t\t\ticon: 'none'\n\t\t\t\t});\n\t\t\t\treject(err);\n\t\t\t}\n\t\t});\n\t});\n}\n\nexport default {\n\tget,\n\tpost,\n\tput,\n\tdel,\n\tdownload\n};\n"],"names":["uni"],"mappings":"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"}